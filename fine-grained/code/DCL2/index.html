
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="ffx">
      
      
        <link rel="canonical" href="https://ffuxiang.gitee.io/fine-grained/code/DCL2/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>细粒度：DCL - ffx的个人博客</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.fad675c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dcl" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="ffx的个人博客" class="md-header__button md-logo" aria-label="ffx的个人博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ffx的个人博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              细粒度：DCL
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://ffuxiang.gitee.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Ffuxiang
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ffx的个人博客" class="md-nav__button md-logo" aria-label="ffx的个人博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ffx的个人博客
  </label>
  
    <div class="md-nav__source">
      <a href="https://ffuxiang.gitee.io/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Ffuxiang
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../resume/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人简历
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fined_domain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    细粒度/域适应笔记
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    目标检测
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            目标检测
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/detection_sum/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    目标检测汇总
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    关键概念
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            关键概念
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/concept/anchor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    锚点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/concept/regression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    回归参数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/concept/IoU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IoU
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    通用程序
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            通用程序
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3_1" >
        
          
          <label class="md-nav__link" for="__nav_4_3_1" id="__nav_4_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数据增强
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3_1">
            <span class="md-nav__icon md-icon"></span>
            数据增强
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/data_augment/affine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    仿射变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/data_augment/mosaic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mosaic增强
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/anchor_gen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    锚点生成
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/anchor_match/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    锚点匹配
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/regression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    参数编码解码
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/IoU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算IoU
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/program/train/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    训练程序
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    检测网络
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            检测网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_4_1" id="__nav_4_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Faster R-CNN
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_1">
            <span class="md-nav__icon md-icon"></span>
            Faster R-CNN
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/Faster_RCNN/structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络结构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/Faster_RCNN/RPN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RPN模块
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/Faster_RCNN/ROI_Head/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ROI Head模块
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/RetinaNet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RetinaNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_4_3" id="__nav_4_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    YOLO系列
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4_3">
            <span class="md-nav__icon md-icon"></span>
            YOLO系列
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/YOLO/YOLOv3_SPP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YOLOv3-SPP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/network/YOLO/YOLOv4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YOLOv4
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DETR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DeDETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deformable DETR
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    常用模块
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            常用模块
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/module/FPN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FPN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/module/FL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../detection/module/NL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    自动驾驶
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            自动驾驶
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    论文笔记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            论文笔记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../auto/paper/HADAR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HADAR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../auto/paper/BEVFormer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BEVFormer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DeDETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deformable DETR
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../auto/PCV/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    点云可视化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../auto/PCC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    点云与图像映射
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    视觉SLAM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            视觉SLAM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../auto/SLAM/SLAM_ch3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    三维空间刚体运动
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    transformer系列
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            transformer系列
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/ViT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ViT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/Swin/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Swin Transformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DETR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DeDETR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deformable DETR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/Maskformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maskformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/ViT_Adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ViT Adapter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/DINO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DINO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../transformer/CLIP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLIP及相关改进工作
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    强化学习
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            强化学习
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../RL/DQN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DQN算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../RL/AC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AC算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../RL/PPO/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PPO算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../RL/DDPG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDPG算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../RL/landing_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    《RL落地指南》笔记
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    图像增强
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            图像增强
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    HDR
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            HDR
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/HDR/HDR-Transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HDT-Transformer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    扩散模型
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            扩散模型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/DDPM/DDPM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDPM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/DDPM/GDP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GDP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数据集
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            数据集
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/dataset/deraining/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    去雨
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/dataset/HDR_dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HDR
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    评测指标
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            评测指标
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/matrix/PSNR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PSNR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../img_enhance/matrix/SSIM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SSIM
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    其他论文
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            其他论文
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other_paper/PartialConv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    局部卷积
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other_paper/attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    注意力机制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other_paper/Cycle_GAN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cycle GAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other_paper/saliency_sampling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    显著性采样
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other_paper/GradCAM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Grad-CAM
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PyTorch
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            PyTorch
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/sum_pytorch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PyTorch学习笔记汇总
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2" >
        
          
          <label class="md-nav__link" for="__nav_10_2" id="__nav_10_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    nn方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2">
            <span class="md-nav__icon md-icon"></span>
            nn方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2_1" >
        
          
          <label class="md-nav__link" for="__nav_10_2_1" id="__nav_10_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    网络结构
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2_1">
            <span class="md-nav__icon md-icon"></span>
            网络结构
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.Linear/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Linear
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.Conv2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Conv2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.BatchNorm2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.BatchNorm2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.AvgPool2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.AvgPool2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.AdaptiveAvgPool2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.AdaptiveAvgPool2d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.Dropout/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Dropout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.MultiheadAttention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.MultiheadAttention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/layers/nn.Embedding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Embedding
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2_2" >
        
          
          <label class="md-nav__link" for="__nav_10_2_2" id="__nav_10_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    激活函数
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2_2">
            <span class="md-nav__icon md-icon"></span>
            激活函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.ReLU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.ReLU
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.LeakyReLU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.LeakyReLU
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.PReLU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.PReLU
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.Sigmoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Sigmoid
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.Tanh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.Tanh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/activations/nn.GELU/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.GeLU
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2_3" >
        
          
          <label class="md-nav__link" for="__nav_10_2_3" id="__nav_10_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    损失函数
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2_3">
            <span class="md-nav__icon md-icon"></span>
            损失函数
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.L1Loss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.L1Loss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.MSELoss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.MSELoss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.CrossEntropyLoss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.CrossEntropyLoss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.KLDivLoss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.KLDivLoss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.MarginRankingLoss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.MarginRankingLoss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.SmoothL1Loss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.SmoothL1Loss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/loss_functions/nn.TripletMarginLoss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nn.TripletMarginLoss
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_2_4" >
        
          
          <label class="md-nav__link" for="__nav_10_2_4" id="__nav_10_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    nn.functional方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_2_4">
            <span class="md-nav__icon md-icon"></span>
            nn.functional方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/F/F.interpolate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    F.interpolate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/nn/F/F.normalize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    F.normalize
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_3" >
        
          
          <label class="md-nav__link" for="__nav_10_3" id="__nav_10_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    utils.data方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_3">
            <span class="md-nav__icon md-icon"></span>
            utils.data方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/data/data.RandomSampler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data.RandomSampler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/data/data.WeightedRandomSampler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data.WeightedRandomSampler
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/data/data.BatchSampler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    data.BatchSampler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    optim方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            optim方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/optim/LambdaLR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LambdaLR
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_5" >
        
          
          <label class="md-nav__link" for="__nav_10_5" id="__nav_10_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    torch方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            torch方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.cat_torch.stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.cat与torch.stack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.chunk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.chunk
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.clamp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.clamp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.div/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.div
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.ge_gt_le_lt_ne_eq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.ge_gt_le_lt_ne_eq
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.from_numpy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.from_numpy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.gather/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.gather
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.index_select/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.index_select
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.max/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.max
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.mul/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.mul
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.nonzero/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.nonzero
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.repeat_interleave_tensor.repeat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.repeat_interleave与tensor.repeat
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.squeeze_torch.unsqueeze/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.squeeze与torch.unsqueeze
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.transpose_tensor.permute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.transpose与tensor.permute
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/torch/torch.where/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    torch.where
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_6" >
        
          
          <label class="md-nav__link" for="__nav_10_6" id="__nav_10_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    其他方法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_6">
            <span class="md-nav__icon md-icon"></span>
            其他方法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/other_method/hook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hook模块
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/other_method/train_eval/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    train与eval
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/other_method/cuda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cuda方法
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../PyTorch/question/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常见问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    常用Python库
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            常用Python库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/tqdm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tqdm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/rearrange/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rearrange
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    LaTeX
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            LaTeX
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LaTeX/symbol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    特殊符号
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_1" >
        
          
          <label class="md-nav__link" for="__nav_13_1" id="__nav_13_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux常用指令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_13_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13_1">
            <span class="md-nav__icon md-icon"></span>
            Linux常用指令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/instruct/conda_pip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conda pip
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/instruct/bypy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bypy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/instruct/screen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    screen命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/instruct/apt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    apt命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/instruct/PID/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    查看进程信息
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_2" >
        
          
          <label class="md-nav__link" for="__nav_13_2" id="__nav_13_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    报错记录
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_13_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13_2">
            <span class="md-nav__icon md-icon"></span>
            报错记录
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/error/sum_error/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    汇总
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_2_2" >
        
          
          <label class="md-nav__link" for="__nav_13_2_2" id="__nav_13_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    系统相关
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_13_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13_2_2">
            <span class="md-nav__icon md-icon"></span>
            系统相关
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/error/linux1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Failed CC version
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_2_3" >
        
          
          <label class="md-nav__link" for="__nav_13_2_3" id="__nav_13_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    NVIDIA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_13_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13_2_3">
            <span class="md-nav__icon md-icon"></span>
            NVIDIA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/error/nvidia/nvidia1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NVIDIA-SMI has failed
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Linux/error/nvidia/nvidia2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NVIDIA kernel module already loaded
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    其他
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            其他
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other/email/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    邮件模板
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other/website/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网站汇总
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../other/program/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常用程序
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      综述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dcl_1" class="md-nav__link">
    <span class="md-ellipsis">
      DCL网络结构
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DCL网络结构">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      网络初始化阶段
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      前向传播阶段
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      数据集的加载
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      训练过程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="训练过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      训练初始化阶段
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      训练流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      验证流程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="dcl">细粒度：DCL<a class="headerlink" href="#dcl" title="Permanent link">&para;</a></h1>
<h2 id="_1">综述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<blockquote>
<p>会议时间：IEEE Conference on Computer Vision and Pattern Recognition 2019 (CVPR, 2019)</p>
<p>论文地址：<a href="https://openaccess.thecvf.com/content_CVPR_2019/papers/Chen_Destruction_and_Construction_Learning_for_Fine-Grained_Image_Recognition_CVPR_2019_paper.pdf">https://openaccess.thecvf.com/content_CVPR_2019/papers/Chen_Destruction_and_Construction_Learning_for_Fine-Grained_Image_Recognition_CVPR_2019_paper.pdf</a></p>
<p>源码地址(PyTorch版本)：<a href="https://github.com/JDAI-CV/DCL">https://github.com/JDAI-CV/DCL</a></p>
<p>针对领域：细粒度图像分类(FGVC)</p>
</blockquote>
<h2 id="dcl_1">DCL网络结构<a class="headerlink" href="#dcl_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">网络初始化阶段<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MainModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MainModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># 使用DCL网络</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_dcl</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">use_dcl</span>
        <span class="c1"># 分类数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">numcls</span>
        <span class="c1"># 特征提取网络名字</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">backbone</span>
        <span class="c1"># 论文中未提及Asoftmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_Asoftmax</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">use_Asoftmax</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span><span class="p">)</span>
        <span class="c1"># 加载主干特征提取网络</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span><span class="p">)()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="ow">in</span> <span class="n">pretrained_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="ow">in</span> <span class="n">pretrained_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pretrainedmodels</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span><span class="p">](</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">pretrainedmodels</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span><span class="p">](</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="c1"># 提取特征提取网络中的卷积、池化层，作为DCL的特征提取模块</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">==</span> <span class="s1">&#39;resnet50&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">==</span> <span class="s1">&#39;se_resnet50&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">==</span> <span class="s1">&#39;senet154&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">==</span> <span class="s1">&#39;se_resnext101_32x4d&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone_arch</span> <span class="o">==</span> <span class="s1">&#39;se_resnet101&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1"># 定义全局平均池化层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="n">output_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 定义分类层</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">cls_2</span><span class="p">:</span>
                <span class="c1"># self.classifier_swap相当于论文中的discriminator(鉴别器)，用于预测该图是原图的概率(未被打乱)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classifier_swap</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">cls_2xmul</span><span class="p">:</span>
                <span class="c1"># xmul论文中未提</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classifier_swap</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># 用于重构图像，对应论文中的construction learning模块</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Convmask</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avgpool2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># 论文中未提及Asoftmax模块</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_Asoftmax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Aclassifier</span> <span class="o">=</span> <span class="n">AngleLinear</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<h3 id="_3">前向传播阶段<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">last_cont</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 将图片经过预先设置好的特征提取网络进行提取特征</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
            <span class="c1"># construction learning模块</span>
            <span class="c1"># 下面对应论文中的公式(8)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Convmask</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgpool2</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="c1"># 生成长度为49的张量数据，表示原图每个区域的位置序号</span>
            <span class="c1"># 可以实现复原原图(或打乱的图像)的作用</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 将特征图传入全连接层，预测概率</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 得到图片的预测概率</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
            <span class="c1"># 预测该图是原始图像的概率，用于计算对抗损失(论文中的公式(6))</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classifier_swap</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="c1"># 预测的原图区域顺序，用于计算论文中的公式(9)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="c1"># use_Asoftmax模块论文中未提及</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_Asoftmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_cont</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Aclassifier</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x_size</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">last_cont</span><span class="p">)</span>
                <span class="n">last_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span><span class="p">(</span><span class="n">last_x</span><span class="p">)</span>
                <span class="n">last_x</span> <span class="o">=</span> <span class="n">last_x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">last_x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Aclassifier</span><span class="p">(</span><span class="n">last_x</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out</span>
</code></pre></div>
<h2 id="_4">数据集的加载<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">dataset</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Config</span><span class="p">,</span> <span class="n">anno</span><span class="p">,</span> <span class="n">swap_size</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">],</span> <span class="n">common_aug</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">totensor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">train_val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># 数据集图片根目录</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">rawdata_root</span>
        <span class="c1"># 数据集类别数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numcls</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">numcls</span>
        <span class="c1"># 数据集名称</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cls_2</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">cls_2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cls_mul</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">cls_2xmul</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># 图片名称,便于后续读取</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;ImageName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="c1"># 图片标签</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anno</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;img_name&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">train_val</span><span class="p">:</span>
            <span class="c1"># 训练时是否验证，如果需要验证，则加载验证集</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">random_sample</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="c1"># 训练图片预处理策略:放大、随机裁剪等等</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">common_aug</span> <span class="o">=</span> <span class="n">common_aug</span>
        <span class="c1"># 随机打乱,具体过程见swap函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap</span> <span class="o">=</span> <span class="n">swap</span>
        <span class="c1"># 测试图片预处理-&gt;直接放大、并转化为tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">totensor</span> <span class="o">=</span> <span class="n">totensor</span>
        <span class="c1"># 加载config参数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span>
        <span class="c1"># 如果是True，表示该阶段是训练过程</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_size</span> <span class="o">=</span> <span class="n">swap_size</span>
        <span class="c1"># 与train类似，如果是True，表示该阶段是测试阶段</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="c1"># 图片路径</span>
        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
        <span class="c1"># 读取图片</span>
        <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pil_loader</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="c1"># 如果是测试过程，则直接放大，然后返回tensor格式的原图即可，无需打乱</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="c1"># 将未打乱的图片进行预处理：调整大小、随机旋转、随机裁剪指定大小</span>
        <span class="n">img_unswap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_aug</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_aug</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">img</span>
        <span class="c1"># 得到原图的小区域块</span>
        <span class="n">image_unswap_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">img_unswap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_size</span><span class="p">)</span>
        <span class="c1"># swap_range表示一共多少个小区域</span>
        <span class="n">swap_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># 将区域块序列缩放到-0.5到0.5内，得到第一个顺序标签(未打乱的图)，用于计算论文中的公式(9)</span>
        <span class="n">swap_law1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="n">swap_range</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">swap_range</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swap_range</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">:</span>
            <span class="c1"># 将原图打乱，得到打乱的图片</span>
            <span class="n">img_swap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">img_unswap</span><span class="p">)</span>
            <span class="c1"># 得到打乱图片的区域块(49张子图)</span>
            <span class="n">image_swap_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crop_image</span><span class="p">(</span><span class="n">img_swap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap_size</span><span class="p">)</span>
            <span class="c1"># 针对未打乱的每张子图，首先获取子图中每个通道的像素值的平均值，之后再求和，得到49个数，下面同理</span>
            <span class="n">unswap_stats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">ImageStat</span><span class="o">.</span><span class="n">Stat</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">image_unswap_list</span><span class="p">]</span>
            <span class="c1"># 针对打乱的每张子图，首先获取子图中每个通道的像素值的平均值，之后再求和</span>
            <span class="n">swap_stats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">ImageStat</span><span class="o">.</span><span class="n">Stat</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">)</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">image_swap_list</span><span class="p">]</span>

            <span class="n">swap_law2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">swap_im</span> <span class="ow">in</span> <span class="n">swap_stats</span><span class="p">:</span>
                <span class="c1"># 按顺序计算打乱图像区域和未打乱图像区域的距离</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">swap_im</span> <span class="o">-</span> <span class="n">unswap_im</span><span class="p">)</span> <span class="k">for</span> <span class="n">unswap_im</span> <span class="ow">in</span> <span class="n">unswap_stats</span><span class="p">]</span>
                <span class="c1"># 得到最近子图像序号，即得到打乱后图像的子区域位于原图的哪个位置</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">distance</span><span class="p">))</span>
                <span class="c1"># 利用该位置序号，得到相对坐标，生成打乱后区域顺序标签</span>
                <span class="n">swap_law2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="o">-</span><span class="p">(</span><span class="n">swap_range</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">swap_range</span><span class="p">)</span>
            <span class="c1"># 将打乱后的图像数据格式转化为tensor格式</span>
            <span class="n">img_swap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">img_swap</span><span class="p">)</span>
            <span class="c1"># 得到标签</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cls_mul</span><span class="p">:</span>
                <span class="c1"># 该分支论文中未提及</span>
                <span class="n">label_swap</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">numcls</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cls_2</span><span class="p">:</span>
                <span class="c1"># label_swap具体作用见collate_fn4train方法</span>
                <span class="n">label_swap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># 数据转化为tensor格式</span>
            <span class="n">img_unswap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">img_unswap</span><span class="p">)</span>
            <span class="c1"># 依次返回未打乱的图片、打乱的图片、类别标签、是否打乱的标签、未打乱图像的区域顺序标签、打乱图像的区域顺序标签、图片名</span>
            <span class="k">return</span> <span class="n">img_unswap</span><span class="p">,</span> <span class="n">img_swap</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">label_swap</span><span class="p">,</span> <span class="n">swap_law1</span><span class="p">,</span> <span class="n">swap_law2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 如果是测试过程，则直接返回原图标签</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="c1"># 原图的区域顺序标签</span>
            <span class="n">swap_law2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="p">(</span><span class="n">swap_range</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">swap_range</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swap_range</span><span class="p">)]</span>
            <span class="n">label_swap</span> <span class="o">=</span> <span class="n">label</span>
            <span class="c1"># 数据转化为tensor格式</span>
            <span class="n">img_unswap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totensor</span><span class="p">(</span><span class="n">img_unswap</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">img_unswap</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">label_swap</span><span class="p">,</span> <span class="n">swap_law1</span><span class="p">,</span> <span class="n">swap_law2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</code></pre></div>
<p><strong>transforms方法</strong>：数据预处理</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_data_transformers</span><span class="p">(</span><span class="n">resize_reso</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">crop_reso</span><span class="o">=</span><span class="mi">448</span><span class="p">,</span> <span class="n">swap_num</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">]):</span>
    <span class="n">center_resize</span> <span class="o">=</span> <span class="mi">600</span>
    <span class="n">Normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
    <span class="n">data_transforms</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># 将数据打乱</span>
        <span class="s1">&#39;swap&#39;</span><span class="p">:</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Randomswap</span><span class="p">((</span><span class="n">swap_num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">swap_num</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
        <span class="p">]),</span>
        <span class="c1"># 训练图片预处理策略</span>
        <span class="s1">&#39;common_aug&#39;</span><span class="p">:</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="c1"># 放大</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_reso</span><span class="p">,</span> <span class="n">resize_reso</span><span class="p">)),</span>
            <span class="c1"># 随机旋转</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomRotation</span><span class="p">(</span><span class="n">degrees</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
            <span class="c1"># 随机裁剪</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomCrop</span><span class="p">((</span><span class="n">crop_reso</span><span class="p">,</span><span class="n">crop_reso</span><span class="p">)),</span>
            <span class="c1"># 随机水平翻转</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
        <span class="p">]),</span>
        <span class="c1"># 转化为tensor格式，三种阶段处理方法相同:放大-&gt;数据类型转换-&gt;标准化</span>
        <span class="s1">&#39;train_totensor&#39;</span><span class="p">:</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">crop_reso</span><span class="p">,</span> <span class="n">crop_reso</span><span class="p">)),</span>
            <span class="c1"># ImageNetPolicy(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
        <span class="p">]),</span>
        <span class="s1">&#39;val_totensor&#39;</span><span class="p">:</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">crop_reso</span><span class="p">,</span> <span class="n">crop_reso</span><span class="p">)),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
        <span class="p">]),</span>
        <span class="s1">&#39;test_totensor&#39;</span><span class="p">:</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">((</span><span class="n">resize_reso</span><span class="p">,</span> <span class="n">resize_reso</span><span class="p">)),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">((</span><span class="n">crop_reso</span><span class="p">,</span> <span class="n">crop_reso</span><span class="p">)),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">([</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]),</span>
        <span class="p">]),</span>
        <span class="s1">&#39;None&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data_transforms</span>
</code></pre></div>
<p><strong>swap函数</strong>：打乱原图(对应论文公式(1)-(3))</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">crop_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cropnum</span><span class="p">):</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># x,y代表区域左上角，通过进一步利用x,y可以裁剪小区域</span>
        <span class="n">crop_x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">width</span> <span class="o">/</span> <span class="n">cropnum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cropnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">crop_y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">high</span> <span class="o">/</span> <span class="n">cropnum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cropnum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">im_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crop_y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crop_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># 将裁剪得到的区域保存到im_list中</span>
                <span class="n">im_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">crop_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">crop_y</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="nb">min</span><span class="p">(</span><span class="n">crop_x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">crop_y</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">high</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">im_list</span>
    <span class="c1"># 原图的宽、高</span>
    <span class="n">widthcut</span><span class="p">,</span> <span class="n">highcut</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
    <span class="c1"># 删去原图周围10*10的区域</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">widthcut</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">highcut</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
    <span class="c1"># 将原图变成区域块，返回的images长度为49,代表49个子区域(宽高各7)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">crop_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">crop</span><span class="p">)</span>
    <span class="n">pro</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">pro</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>          
        <span class="n">tmpx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmpy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">count_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># RAN相当于论文中的超参数k</span>
        <span class="n">RAN</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="c1"># 打乱操作，对应论文公式(1)-(3)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">tmpx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># count_x表示每行中，取得的图片数量，每取一张图片，就加一</span>
            <span class="n">count_x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
                <span class="c1"># 选取后两个数据</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpx</span><span class="p">[</span><span class="n">count_x</span> <span class="o">-</span> <span class="n">RAN</span><span class="p">:</span><span class="n">count_x</span><span class="p">]</span>
                <span class="c1"># 进行打乱(相当于对列打乱)</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="c1"># 重新赋值</span>
                <span class="n">tmpx</span><span class="p">[</span><span class="n">count_x</span> <span class="o">-</span> <span class="n">RAN</span><span class="p">:</span><span class="n">count_x</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
            <span class="c1"># 如果第一行子区域数量达到预先设置好的数量(7个)，则count_x归零(换行操作)</span>
            <span class="k">if</span> <span class="n">count_x</span> <span class="o">==</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># tmpy储存总的图片序号</span>
                <span class="n">tmpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmpx</span><span class="p">)</span>
                <span class="c1"># count_x归零</span>
                <span class="n">count_x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># count_y表示行数</span>
                <span class="n">count_y</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># tmpx清零</span>
                <span class="n">tmpx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># 如果行数非零，则也对行进行打乱，对行打乱时，不改变行内部顺序，只改变行间顺序</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
                <span class="c1"># 同样，对后两行(设置好的超参数)进行打乱</span>
                <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmpy</span><span class="p">[</span><span class="n">count_y</span> <span class="o">-</span> <span class="n">RAN</span><span class="p">:</span><span class="n">count_y</span><span class="p">]</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
                <span class="c1"># 重新赋值</span>
                <span class="n">tmpy</span><span class="p">[</span><span class="n">count_y</span> <span class="o">-</span> <span class="n">RAN</span><span class="p">:</span><span class="n">count_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp2</span>
        <span class="n">random_im</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tmpy</span><span class="p">:</span>
            <span class="c1"># 得到打乱后的区域块顺序</span>
            <span class="n">random_im</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># random.shuffle(images)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># 得到每块小区域的期望大小</span>
        <span class="c1"># 之前在裁剪小区域之前，由于删掉了周围10个像素，所以如果不加以放大，拼出来的图和原图尺寸不一样</span>
        <span class="n">iw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ih</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">high</span> <span class="o">/</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 得到新图片toImage</span>
        <span class="n">toImage</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">iw</span> <span class="o">*</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ih</span> <span class="o">*</span> <span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># 遍历每块区域</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">random_im</span><span class="p">:</span>
            <span class="c1"># 将区域块放大到期望的大小</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">iw</span><span class="p">,</span> <span class="n">ih</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
            <span class="c1"># 将打乱后的区域块依次粘贴到原图指定的位置上</span>
            <span class="c1"># 所有图片粘贴完，得到的图像就是打乱后的图片</span>
            <span class="n">toImage</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">iw</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">ih</span><span class="p">))</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">toImage</span> <span class="o">=</span> <span class="n">img</span>
    <span class="n">toImage</span> <span class="o">=</span> <span class="n">toImage</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">widthcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">))</span>
    <span class="c1"># 最后返回打乱后的图片</span>
    <span class="k">return</span> <span class="n">toImage</span>
</code></pre></div>
<p><strong>collate方法</strong>：以训练集图片加载为例</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">collate_fn4train</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">label_swap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">law_swap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 这里的sample表示采样得到的数据</span>
    <span class="c1"># sample与dataset函数中__getitem__方法返回的变量一样</span>
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="c1"># 前两个变量均表示图片，只是含义不同</span>
        <span class="c1"># 因此将前两个图片合并到一个变量中</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 并且将标签也合并</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sample</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 第一个标签表示未被破坏，第二个表示图片被破坏</span>
            <span class="n">label_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">label_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">label_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="c1"># label_swap表示区域块的顺序</span>
        <span class="c1"># 分别为原图的区域块顺序和被破坏后图像的区域块顺序</span>
        <span class="n">law_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">law_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="c1"># img_name表示图片名称</span>
        <span class="n">img_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># 依次返回图片数据、标签、是否打乱的标签、区域块顺序、图片名称</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="p">,</span> <span class="n">label_swap</span><span class="p">,</span> <span class="n">law_swap</span><span class="p">,</span> <span class="n">img_name</span>
</code></pre></div>
<h2 id="_5">训练过程<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">训练初始化阶段<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 加载超参数config</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Config</span> <span class="o">=</span> <span class="n">LoadConfig</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">)</span>
    <span class="n">Config</span><span class="o">.</span><span class="n">cls_2</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cls_2</span>
    <span class="n">Config</span><span class="o">.</span><span class="n">cls_2xmul</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cls_mul</span>
    <span class="k">assert</span> <span class="n">Config</span><span class="o">.</span><span class="n">cls_2</span> <span class="o">^</span> <span class="n">Config</span><span class="o">.</span><span class="n">cls_2xmul</span>
    <span class="c1"># 加载数据预处理方法</span>
    <span class="n">transformers</span> <span class="o">=</span> <span class="n">load_data_transformers</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resize_resolution</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">crop_resolution</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">swap_num</span><span class="p">)</span>
    <span class="c1"># inital dataloader</span>
    <span class="c1"># 加载训练集</span>
    <span class="n">train_set</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">,</span>\
                        <span class="n">anno</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">train_anno</span><span class="p">,</span>\
                        <span class="n">common_aug</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;common_aug&quot;</span><span class="p">],</span>\
                        <span class="n">swap</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;swap&quot;</span><span class="p">],</span>\
                        <span class="n">totensor</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;train_totensor&quot;</span><span class="p">],</span>\
                        <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 加载验证集</span>
    <span class="n">trainval_set</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">,</span>\
                        <span class="n">anno</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">train_anno</span><span class="p">,</span>\
                        <span class="n">common_aug</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">],</span>\
                        <span class="n">swap</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">],</span>\
                        <span class="n">totensor</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;val_totensor&quot;</span><span class="p">],</span>\
                        <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">train_val</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 加载测试集</span>
    <span class="n">val_set</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span><span class="n">Config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">,</span>\
                      <span class="n">anno</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">val_anno</span><span class="p">,</span>\
                      <span class="n">common_aug</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">],</span>\
                      <span class="n">swap</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">],</span>\
                      <span class="n">totensor</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="s2">&quot;test_totensor&quot;</span><span class="p">],</span>\
                      <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">dataloader</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># 生成训练数据迭代器</span>
    <span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span>\
                                                <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_batch</span><span class="p">,</span>\
                                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>\
                                                <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">train_num_workers</span><span class="p">,</span>\
                                                <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn4train</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="n">collate_fn4backbone</span><span class="p">,</span>
                                                <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 设置dataloader[&#39;train&#39;]中，total_item_len的属性值为len(train_set)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">],</span> <span class="s1">&#39;total_item_len&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_set</span><span class="p">))</span>
    <span class="c1"># 生成验证数据迭代器</span>
    <span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;trainval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainval_set</span><span class="p">,</span>\
                                                <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">val_batch</span><span class="p">,</span>\
                                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                                                <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">val_num_workers</span><span class="p">,</span>\
                                                <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn4val</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="n">collate_fn4backbone</span><span class="p">,</span>
                                                <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 与trian相同，设置dataloader[&#39;trainval&#39;]中total_item_len属性为len(trainval_set)，num_cls属性为Config.numcls</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;trainval&#39;</span><span class="p">],</span> <span class="s1">&#39;total_item_len&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainval_set</span><span class="p">))</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;trainval&#39;</span><span class="p">],</span> <span class="s1">&#39;num_cls&#39;</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">numcls</span><span class="p">)</span>
    <span class="c1"># 加载测试数据集</span>
    <span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">val_set</span><span class="p">,</span>\
                                                <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">val_batch</span><span class="p">,</span>\
                                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                                                <span class="n">num_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">val_num_workers</span><span class="p">,</span>\
                                                <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn4test</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="n">collate_fn4backbone</span><span class="p">,</span>
                                                <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">setattr</span><span class="p">(</span><span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;total_item_len&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_set</span><span class="p">))</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">dataloader</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;num_cls&#39;</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">numcls</span><span class="p">)</span>
    <span class="c1"># 优化模型训练效率</span>
    <span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Choose model and train set&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 加载模型</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">MainModel</span><span class="p">(</span><span class="n">Config</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_resume</span><span class="p">):</span>
        <span class="c1"># 若无预训练模型，则只加载ImageNet预训练模型</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;train from imagenet pretrained models ...&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 如果有预训练模型，则加载预训练模型</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resume</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;load from pretrained checkpoint </span><span class="si">%s</span><span class="s1"> ...&#39;</span><span class="o">%</span> <span class="n">resume</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_resume</span><span class="p">:</span>
            <span class="n">resume</span> <span class="o">=</span> <span class="n">auto_load_resume</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;load from </span><span class="si">%s</span><span class="s1"> ...&#39;</span><span class="o">%</span><span class="n">resume</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no checkpoints to load&quot;</span><span class="p">)</span>
        <span class="c1"># 提取网络模型原始参数</span>
        <span class="n">model_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
        <span class="c1"># 加载预训练模型参数</span>
        <span class="n">pretrained_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resume</span><span class="p">)</span>
        <span class="n">pretrained_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">:]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pretrained_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">}</span>
        <span class="c1"># 更新网络原始参数</span>
        <span class="n">model_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pretrained_dict</span><span class="p">)</span>
        <span class="c1"># 加载参数</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">model_dict</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Set cache dir&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 得到当前时间</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="c1"># 以当前时间定义模型保存地址</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d%d%d</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">discribe</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">Config</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="c1"># 创建地址</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>
    <span class="c1"># 将模型放入显卡中</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="c1"># 多卡并行训练</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">DataParallel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># optimizer prepare</span>
    <span class="c1"># id表示返回对象内存地址</span>
    <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span><span class="p">:</span>
        <span class="n">ignored_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 得到网络模型优化参数</span>
        <span class="n">ignored_params1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
        <span class="n">ignored_params2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier_swap</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
        <span class="n">ignored_params3</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Convmask</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>
        <span class="n">ignored_params</span> <span class="o">=</span> <span class="n">ignored_params1</span> <span class="o">+</span> <span class="n">ignored_params2</span> <span class="o">+</span> <span class="n">ignored_params3</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;the num of new layers:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ignored_params</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># base_params表示特征提取网络的参数</span>
    <span class="n">base_params</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignored_params</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
    <span class="c1"># 学习率比率</span>
    <span class="n">lr_ratio</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">cls_lr_ratio</span>
    <span class="c1"># 基础学习率</span>
    <span class="n">base_lr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">base_lr</span>
    <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">base_params</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">base_lr</span><span class="p">}],</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">base_lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">([{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">base_params</span><span class="p">},</span>
                               <span class="c1"># 这里表示classifier、classifier_swap、Convmask的参数更新速率是其他参数的lr_ratio倍</span>
                               <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr_ratio</span><span class="o">*</span><span class="n">base_lr</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">classifier_swap</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr_ratio</span><span class="o">*</span><span class="n">base_lr</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">Convmask</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">lr_ratio</span><span class="o">*</span><span class="n">base_lr</span><span class="p">},</span>
                              <span class="p">],</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">base_lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="c1"># 学习率更新策略</span>
    <span class="n">exp_lr_scheduler</span> <span class="o">=</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">decay_step</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="c1"># 开始训练</span>
    <span class="c1"># train entry</span>
    <span class="n">train</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span>
          <span class="n">model</span><span class="p">,</span>
          <span class="n">epoch_num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
          <span class="n">start_epoch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">,</span>
          <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
          <span class="n">exp_lr_scheduler</span><span class="o">=</span><span class="n">exp_lr_scheduler</span><span class="p">,</span>
          <span class="n">data_loader</span><span class="o">=</span><span class="n">dataloader</span><span class="p">,</span>
          <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span>
          <span class="n">data_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">crop_resolution</span><span class="p">,</span>
          <span class="n">savepoint</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">save_point</span><span class="p">,</span>
          <span class="n">checkpoint</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">check_point</span><span class="p">)</span>
</code></pre></div>
<h3 id="_7">训练流程<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span>
          <span class="n">model</span><span class="p">,</span>
          <span class="n">epoch_num</span><span class="p">,</span>
          <span class="n">start_epoch</span><span class="p">,</span>
          <span class="n">optimizer</span><span class="p">,</span>
          <span class="n">exp_lr_scheduler</span><span class="p">,</span>
          <span class="n">data_loader</span><span class="p">,</span>
          <span class="n">save_dir</span><span class="p">,</span>
          <span class="n">data_size</span><span class="o">=</span><span class="mi">448</span><span class="p">,</span>
          <span class="n">savepoint</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
          <span class="n">checkpoint</span><span class="o">=</span><span class="mi">1000</span>
          <span class="p">):</span>
    <span class="c1"># savepoint: save without evalution</span>
    <span class="c1"># checkpoint: save with evaluation</span>

    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eval_train_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">rec_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">checkpoint_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># 得到batch_size</span>
    <span class="n">train_batch_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="c1"># 得到每个epoch迭代次数</span>
    <span class="n">train_epoch_step</span> <span class="o">=</span> <span class="n">data_loader</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
    <span class="c1"># 加载记录损失的类</span>
    <span class="n">train_loss_recorder</span> <span class="o">=</span> <span class="n">LossRecord</span><span class="p">(</span><span class="n">train_batch_size</span><span class="p">)</span>
    <span class="c1"># 最少每经过一个epoch保存一次模型</span>
    <span class="c1"># 一个epoch里可以保存多次模型</span>
    <span class="k">if</span> <span class="n">savepoint</span> <span class="o">&gt;</span> <span class="n">train_epoch_step</span><span class="p">:</span>
        <span class="n">savepoint</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">train_epoch_step</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">savepoint</span>
    <span class="c1"># 得到当前时间</span>
    <span class="n">date_suffix</span> <span class="o">=</span> <span class="n">dt</span><span class="p">()</span>
    <span class="c1"># 加载日志文件</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="o">.</span><span class="n">log_folder</span><span class="p">,</span> <span class="s1">&#39;formal_log_r50_dcl_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.log&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data_size</span><span class="p">),</span> <span class="n">date_suffix</span><span class="p">)),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="c1"># 定义损失函数</span>
    <span class="n">add_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
    <span class="n">get_ce_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">get_focal_loss</span> <span class="o">=</span> <span class="n">FocalLoss</span><span class="p">()</span>
    <span class="n">get_angle_loss</span> <span class="o">=</span> <span class="n">AngleLoss</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_epoch</span><span class="p">,</span><span class="n">epoch_num</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">exp_lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">save_grad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">batch_cnt</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]):</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># 如果只使用主干特征提取网络，则只需要原始图片与标签</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span><span class="p">:</span>
                <span class="c1"># 得到输入数据、标签与图片名称</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">img_names</span> <span class="o">=</span> <span class="n">data</span>
                <span class="c1"># 将输入与标签转化成变量，便于反向传播</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
                <span class="c1"># 若使用dcl网络，则依次得到图片数据、标签、是否打乱的标签、区域块顺序、图片名称</span>
                <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">labels_swap</span><span class="p">,</span> <span class="n">swap_law</span><span class="p">,</span> <span class="n">img_names</span> <span class="o">=</span> <span class="n">data</span>
                <span class="c1"># 将所有的数据变为变量，便于反向传播</span>
                <span class="n">inputs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
                <span class="n">labels_swap</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels_swap</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
                <span class="n">swap_law</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">swap_law</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
            <span class="c1"># 梯度清零</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">train_batch_size</span><span class="p">:</span>
                <span class="c1"># 与Asoftmax模块有关，论文未提</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 将输入传入模型中，得到输出</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_focal_loss</span><span class="p">:</span>
                <span class="c1"># focal_loss论文中未提</span>
                <span class="n">ce_loss</span> <span class="o">=</span> <span class="n">get_focal_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 图像(原图与打乱后的图)预测值与标签做交叉熵损失</span>
                <span class="n">ce_loss</span> <span class="o">=</span> <span class="n">get_ce_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="p">)</span>
            <span class="c1"># 论文中未提及Asoftmax模块</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_Asoftmax</span><span class="p">:</span>
                <span class="n">fetch_batch</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">batch_cnt</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_epoch_step</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">angle_loss</span> <span class="o">=</span> <span class="n">get_angle_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">fetch_batch</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">angle_loss</span> <span class="o">=</span> <span class="n">get_angle_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">fetch_batch</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">angle_loss</span>

            <span class="n">loss</span> <span class="o">+=</span> <span class="n">ce_loss</span>
            <span class="c1"># alpha_、beta_、gamma_表示各损失的权重，用于计算最后的总损失</span>
            <span class="n">alpha_</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">beta_</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gamma_</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;STCAR&#39;</span> <span class="ow">or</span> <span class="n">Config</span><span class="o">.</span><span class="n">dataset</span> <span class="o">==</span> <span class="s1">&#39;AIR&#39;</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
                <span class="c1"># 对抗损失，对应论文公式(6)</span>
                <span class="c1"># 预测该图是原图的概率，与实际的是否是原图这一标签(论文中的d参数)做交叉熵损失</span>
                <span class="n">swap_loss</span> <span class="o">=</span> <span class="n">get_ce_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">labels_swap</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">swap_loss</span>
                <span class="c1"># 利用预测的区域顺序与标签顺序求L1损失，对应论文公式(9)</span>
                <span class="n">law_loss</span> <span class="o">=</span> <span class="n">add_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">swap_law</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">law_loss</span>
            <span class="c1"># 反向传播，求梯度</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="c1"># 等待当前设备上所有流中的所有核心完成(多卡训练时用到)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
            <span class="c1"># 更新参数</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
            <span class="c1"># 输出训练阶段参数</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_dcl</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step: </span><span class="si">{:-8d}</span><span class="s1"> / </span><span class="si">{:d}</span><span class="s1"> loss=ce_loss+swap_loss+law_loss: </span><span class="si">{:6.4f}</span><span class="s1"> = </span><span class="si">{:6.4f}</span><span class="s1"> + </span><span class="si">{:6.4f}</span><span class="s1"> + </span><span class="si">{:6.4f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">train_epoch_step</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">ce_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">swap_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">law_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_backbone</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step: </span><span class="si">{:-8d}</span><span class="s1"> / </span><span class="si">{:d}</span><span class="s1"> loss=ce_loss+swap_loss+law_loss: </span><span class="si">{:6.4f}</span><span class="s1"> = </span><span class="si">{:6.4f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">train_epoch_step</span><span class="p">,</span> <span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">ce_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># 记录损失变化</span>
            <span class="n">rec_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">train_loss_recorder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

            <span class="c1"># evaluation &amp; save，测试与模型保存</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">checkpoint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rec_loss</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;step: </span><span class="si">{:d}</span><span class="s1"> / </span><span class="si">{:d}</span><span class="s1"> global_step: </span><span class="si">{:8.2f}</span><span class="s1"> train_epoch: </span><span class="si">{:04d}</span><span class="s1"> rec_train_loss: </span><span class="si">{:6.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">train_epoch_step</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">step</span><span class="o">/</span><span class="n">train_epoch_step</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss_recorder</span><span class="o">.</span><span class="n">get_val</span><span class="p">()),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;current lr:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">exp_lr_scheduler</span><span class="o">.</span><span class="n">get_lr</span><span class="p">(),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># 是否进行测试(这里可能是多余的)</span>
                <span class="k">if</span> <span class="n">eval_train_flag</span><span class="p">:</span>
                    <span class="c1"># 测试过程，见eval_turn函数</span>
                    <span class="n">trainval_acc1</span><span class="p">,</span> <span class="n">trainval_acc2</span><span class="p">,</span> <span class="n">trainval_acc3</span> <span class="o">=</span> <span class="n">eval_turn</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">[</span><span class="s1">&#39;trainval&#39;</span><span class="p">],</span> <span class="s1">&#39;trainval&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trainval_acc1</span> <span class="o">-</span> <span class="n">trainval_acc3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
                        <span class="c1"># 如果测试结果top-1与top-3精度相差不大，则下一次不再测试</span>
                        <span class="n">eval_train_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># 测试过程，得到top-1、top-2、top-3精度</span>
                <span class="n">val_acc1</span><span class="p">,</span> <span class="n">val_acc2</span><span class="p">,</span> <span class="n">val_acc3</span> <span class="o">=</span> <span class="n">eval_turn</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>
                <span class="c1"># 得到模型保存路径</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;weights_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%.4f</span><span class="s1">_</span><span class="si">%.4f</span><span class="s1">.pth&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">batch_cnt</span><span class="p">,</span> <span class="n">val_acc1</span><span class="p">,</span> <span class="n">val_acc3</span><span class="p">))</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span>
                <span class="c1"># 保存模型参数</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saved model to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">save_path</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># 释放显存</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

            <span class="c1"># 只保存模型</span>
            <span class="k">elif</span> <span class="n">step</span> <span class="o">%</span> <span class="n">savepoint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">train_loss_recorder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rec_loss</span><span class="p">)</span>
                <span class="n">rec_loss</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># 模型保存路径</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;savepoint_weights-</span><span class="si">%d</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.pth&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">dt</span><span class="p">()))</span>
                <span class="c1"># 保存模型路径</span>
                <span class="n">checkpoint_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
                <span class="c1"># 最多同时保存6个模型</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoint_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">checkpoint_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">del</span> <span class="n">checkpoint_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># 保存网络参数</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">save_path</span><span class="p">)</span>
                <span class="c1"># 释放显存</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="c1"># 关闭日志文件</span>
    <span class="n">log_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<h3 id="_8">验证流程<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">eval_turn</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">val_version</span><span class="p">,</span> <span class="n">epoch_num</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
    <span class="c1"># 将模型转为测试阶段(不更新参数)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 初始化用于储存精度的变量</span>
    <span class="n">val_corrects1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">val_corrects2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">val_corrects3</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># 测试集大小</span>
    <span class="n">val_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
    <span class="c1"># 测试集图片数量</span>
    <span class="n">item_count</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">total_item_len</span>
    <span class="c1"># 初始化时间</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># 定义损失函数</span>
    <span class="n">get_l1_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
    <span class="n">get_ce_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="c1"># 得到batch_size大小与测试总次数(每个epoch需要预测多少次)</span>
    <span class="n">val_batch_size</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">batch_size</span>
    <span class="n">val_epoch_step</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>
    <span class="c1"># 得到类别数量</span>
    <span class="n">num_cls</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">num_cls</span>
    <span class="c1"># 记录损失变化过程</span>
    <span class="n">val_loss_recorder</span> <span class="o">=</span> <span class="n">LossRecord</span><span class="p">(</span><span class="n">val_batch_size</span><span class="p">)</span>
    <span class="n">val_celoss_recorder</span> <span class="o">=</span> <span class="n">LossRecord</span><span class="p">(</span><span class="n">val_batch_size</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;evaluating </span><span class="si">%s</span><span class="s1"> ...&#39;</span><span class="o">%</span><span class="n">val_version</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="c1"># 遍历测试集</span>
        <span class="k">for</span> <span class="n">batch_cnt_val</span><span class="p">,</span> <span class="n">data_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
            <span class="c1"># 将数据转变为变量</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">data_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">cuda</span><span class="p">())</span>
            <span class="c1"># 得到输出</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># 得到图片预测概率与图片标签之间的损失</span>
            <span class="n">ce_loss</span> <span class="o">=</span> <span class="n">get_ce_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">ce_loss</span>
            <span class="c1"># 记录得到的损失</span>
            <span class="n">val_loss_recorder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
            <span class="n">val_celoss_recorder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ce_loss</span><span class="p">)</span>
            <span class="c1"># 论文中未提及cls_2xmul</span>
            <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">use_dcl</span> <span class="ow">and</span> <span class="n">Config</span><span class="o">.</span><span class="n">cls_2xmul</span><span class="p">:</span>
                <span class="n">outputs_pred</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">:</span><span class="n">num_cls</span><span class="p">]</span> <span class="o">+</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">num_cls</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">num_cls</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 得到类别预测概率</span>
                <span class="n">outputs_pred</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># torch.topk表示先排序(默认按最后一个维度以降序的顺序排序)，之后取前k个数据</span>
            <span class="c1"># 这里表示取前3个最大的预测概率</span>
            <span class="n">top3_val</span><span class="p">,</span> <span class="n">top3_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">outputs_pred</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="c1"># 输出测试信息</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> eval_batch: </span><span class="si">{:-6d}</span><span class="s1"> / </span><span class="si">{:d}</span><span class="s1"> loss: </span><span class="si">{:8.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val_version</span><span class="p">,</span> <span class="n">batch_cnt_val</span><span class="p">,</span> <span class="n">val_epoch_step</span><span class="p">,</span> <span class="n">loss</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># 下面依次计算top-1、top-2、top-3精度</span>
            <span class="n">batch_corrects1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">top3_pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># val_corrects1表示top-1正确个数</span>
            <span class="n">val_corrects1</span> <span class="o">+=</span> <span class="n">batch_corrects1</span>
            <span class="n">batch_corrects2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">top3_pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># val_corrects2表示top-2(预测概率前2)正确个数</span>
            <span class="n">val_corrects2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">batch_corrects2</span> <span class="o">+</span> <span class="n">batch_corrects1</span><span class="p">)</span>
            <span class="n">batch_corrects3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">top3_pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">labels</span><span class="p">))</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="c1"># val_corrects3表示top-3(预测概率前3)正确个数</span>
            <span class="n">val_corrects3</span> <span class="o">+=</span> <span class="p">(</span><span class="n">batch_corrects3</span> <span class="o">+</span> <span class="n">batch_corrects2</span> <span class="o">+</span> <span class="n">batch_corrects1</span><span class="p">)</span>
        <span class="c1"># 依次得到top-1、top-2、top-3精度</span>
        <span class="n">val_acc1</span> <span class="o">=</span> <span class="n">val_corrects1</span> <span class="o">/</span> <span class="n">item_count</span>
        <span class="n">val_acc2</span> <span class="o">=</span> <span class="n">val_corrects2</span> <span class="o">/</span> <span class="n">item_count</span>
        <span class="n">val_acc3</span> <span class="o">=</span> <span class="n">val_corrects3</span> <span class="o">/</span> <span class="n">item_count</span>
        <span class="c1"># 写入日志</span>
        <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val_version</span>  <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">val_loss_recorder</span><span class="o">.</span><span class="n">get_val</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val_celoss_recorder</span><span class="o">.</span><span class="n">get_val</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val_acc1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val_acc3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># 得到测试终止时间</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># 做差，得到测试时间</span>
        <span class="n">since</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="o">*</span><span class="mi">30</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% 3d</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">-loss: </span><span class="si">%.4f</span><span class="s1"> ||</span><span class="si">%s</span><span class="s1">-acc@1: </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">-acc@2: </span><span class="si">%.4f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">-acc@3: </span><span class="si">%.4f</span><span class="s1"> ||time: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">epoch_num</span><span class="p">,</span> <span class="n">val_version</span><span class="p">,</span> <span class="n">dt</span><span class="p">(),</span> <span class="n">val_version</span><span class="p">,</span> <span class="n">val_loss_recorder</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">val_version</span><span class="p">,</span> <span class="n">val_acc1</span><span class="p">,</span><span class="n">val_version</span><span class="p">,</span> <span class="n">val_acc2</span><span class="p">,</span> <span class="n">val_version</span><span class="p">,</span> <span class="n">val_acc3</span><span class="p">,</span> <span class="n">since</span><span class="p">),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&#39;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># 返回精度</span>
    <span class="k">return</span> <span class="n">val_acc1</span><span class="p">,</span> <span class="n">val_acc2</span><span class="p">,</span> <span class="n">val_acc3</span>
</code></pre></div>
<p>注：以上仅是笔者的个人见解，若有错误，欢迎大家批评指正。</p>
<blockquote>
<p>最后一次修改日期：2021年12月7日</p>
</blockquote>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
        <script src="../../../mathjax-config.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
      
        <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      
    
  </body>
</html>